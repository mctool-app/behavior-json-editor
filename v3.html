<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC Entity Editor</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --highlight-color: #6a6a18;
            --border-color: #3e3e42;
            --pocket-bg: #333333;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        #app {
            display: flex;
            height: 100vh;
        }

        /* å·¦ãƒ‘ãƒãƒ«: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š */
        #sidebar {
            width: 350px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* ãƒã‚±ãƒƒãƒˆ (ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›) */
        #pocket {
            width: 100%;
            height: 80px;
            border: 2px dashed #555;
            border-radius: 8px;
            background-color: var(--pocket-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
            color: #888;
        }

        #pocket:hover, #pocket.dragover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background-color: #2a2d2e;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .control-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .control-group .desc {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 6px;
            background-color: #3c3c3c;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        /* å³ãƒ‘ãƒãƒ«: ã‚³ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ */
        #editor-container {
            flex: 1;
            position: relative;
            background-color: #1e1e1e;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #toolbar {
            height: 40px;
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            justify-content: space-between;
        }

        #code-view {
            flex: 1;
            padding: 20px;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            color: #d4d4d4;
            tab-size: 4;
        }

        /* ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .line { display: block; min-height: 1.5em; }
        .highlight {
            background-color: var(--highlight-color);
            animation: flash 1s ease-out;
        }

        @keyframes flash {
            0% { background-color: #ffff00; color: black; }
            100% { background-color: var(--highlight-color); color: #d4d4d4; }
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .btn:hover { opacity: 0.9; }
        .btn.secondary { background-color: #444; }
        
        .status-badge {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 10px;
            background: #333;
            color: #aaa;
        }
        .status-badge.active {
            background: #8e3e3e;
            color: white;
        }

    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div id="pocket" title="ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—">
            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—<br>(ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯)
            <input type="file" id="fileInput" accept=".json" style="display: none;">
        </div>

        <div id="parameters">
            <p style="text-align: center; color: #666;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨<br>ã“ã“ã«è¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
    </div>

    <div id="editor-container">
        <div id="toolbar">
            <div>
                <span id="edit-status" class="status-badge">View Only</span>
                <span id="filename-display" style="font-size: 12px; color: #888;"></span>
            </div>
            <div>
                <button class="btn secondary" id="toggle-edit-btn">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
                <button class="btn" id="download-btn">JSONã‚’ä¿å­˜</button>
            </div>
        </div>
        <div id="code-view" contenteditable="false">
            // ã“ã“ã«JSONã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...
        </div>
    </div>
</div>

<script>
    // --- åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨è¨­å®š ---
    let currentData = {};
    let isEditMode = false;
    let currentHighlightLine = -1;

    // ç·¨é›†å¯¾è±¡ã¨ã™ã‚‹ä¸»ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å®šç¾©
    // path: JSONå†…ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ (.ã§éšå±¤åŒºåˆ‡ã‚Š)
    // label: è¡¨ç¤ºå
    // desc: èª¬æ˜æ–‡
    // type: å…¥åŠ›ã‚¿ã‚¤ãƒ— (text, number, boolean)
    const paramConfig = [
        {
            id: "identifier",
            label: "ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID",
            path: "minecraft:entity.description.identifier",
            type: "text",
            desc: "ã‚²ãƒ¼ãƒ å†…ã§ã®è­˜åˆ¥å (ä¾‹: myname:entity)"
        },
        {
            id: "health",
            label: "ä½“åŠ› (HP)",
            path: "minecraft:entity.components.minecraft:health.value",
            type: "number",
            desc: "ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æœ€å¤§ä½“åŠ›"
        },
        {
            id: "attack",
            label: "æ”»æ’ƒåŠ›",
            path: "minecraft:entity.components.minecraft:attack.damage",
            type: "number",
            desc: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸é‡"
        },
        {
            id: "scale",
            label: "å¤§ãã• (Scale)",
            // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚°ãƒ«ãƒ¼ãƒ—å†…ã«ã‚ã‚‹å ´åˆãŒå¤šã„ãŒã€åŸºæœ¬è¨­å®šã«ã‚ã‚Œã°ã“ã“
            path: "minecraft:entity.components.minecraft:scale.value", 
            type: "number",
            desc: "è¦‹ãŸç›®ã®å¤§ãã•ã®å€ç‡"
        },
        {
            id: "width",
            label: "å½“ãŸã‚Šåˆ¤å®š (å¹…)",
            path: "minecraft:entity.components.minecraft:collision_box.width",
            type: "number",
            desc: "è¡çªåˆ¤å®šã®å¹…"
        },
        {
            id: "height",
            label: "å½“ãŸã‚Šåˆ¤å®š (é«˜ã•)",
            path: "minecraft:entity.components.minecraft:collision_box.height",
            type: "number",
            desc: "è¡çªåˆ¤å®šã®é«˜ã•"
        },
        {
            id: "movement",
            label: "ç§»å‹•é€Ÿåº¦",
            path: "minecraft:entity.components.minecraft:movement.value",
            type: "number",
            desc: "æ­©è¡Œæ™‚ã®åŸºæœ¬ç§»å‹•é€Ÿåº¦"
        },
        {
            id: "family",
            label: "ç¨®æ— (Family)",
            path: "minecraft:entity.components.minecraft:type_family.family",
            type: "array", // ç°¡æ˜“çš„ã«ãƒ†ã‚­ã‚¹ãƒˆã§ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šè¡¨ç¤ºã«ã™ã‚‹
            desc: "æ‰€å±ã™ã‚‹ãƒ•ã‚¡ãƒŸãƒªãƒ¼ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)"
        },
        {
            id: "loot",
            label: "ãƒ‰ãƒ­ãƒƒãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«",
            path: "minecraft:entity.components.minecraft:loot.table",
            type: "text",
            desc: "å€’ã—ãŸæ™‚ã«è½ã¨ã™ã‚¢ã‚¤ãƒ†ãƒ ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹"
        }
    ];

    // --- DOMè¦ç´  ---
    const pocket = document.getElementById('pocket');
    const fileInput = document.getElementById('fileInput');
    const paramsContainer = document.getElementById('parameters');
    const codeView = document.getElementById('code-view');
    const toggleEditBtn = document.getElementById('toggle-edit-btn');
    const editStatus = document.getElementById('edit-status');
    const downloadBtn = document.getElementById('download-btn');

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
    pocket.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => loadFile(e.target.files[0]));

    pocket.addEventListener('dragover', (e) => {
        e.preventDefault();
        pocket.classList.add('dragover');
    });
    pocket.addEventListener('dragleave', () => pocket.classList.remove('dragover'));
    pocket.addEventListener('drop', (e) => {
        e.preventDefault();
        pocket.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            loadFile(e.dataTransfer.files[0]);
        }
    });

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    toggleEditBtn.addEventListener('click', () => {
        isEditMode = !isEditMode;
        codeView.contentEditable = isEditMode;
        if (isEditMode) {
            editStatus.textContent = "Editing Code";
            editStatus.classList.add('active');
            codeView.style.border = "1px solid #8e3e3e";
        } else {
            editStatus.textContent = "View Only";
            editStatus.classList.remove('active');
            codeView.style.border = "none";
            // ã‚³ãƒ¼ãƒ‰ç·¨é›†ã‹ã‚‰æˆ»ã£ãŸæ™‚ã«JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
            try {
                const text = codeView.innerText;
                currentData = JSON.parse(text);
                renderControls();
                renderCode(); // æ•´å½¢ã—ãªãŠã—
            } catch (e) {
                alert("JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
                isEditMode = true; // æˆ»ã™
                codeView.contentEditable = true;
            }
        }
    });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    downloadBtn.addEventListener('click', () => {
        if (!currentData) return;
        const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'entity.json';
        a.click();
        URL.revokeObjectURL(url);
    });

    // --- ãƒ­ã‚¸ãƒƒã‚¯ ---

    function loadFile(file) {
        if (!file) return;
        document.getElementById('filename-display').textContent = file.name;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                currentData = JSON.parse(e.target.result);
                renderControls();
                renderCode();
            } catch (err) {
                alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + err);
            }
        };
        reader.readAsText(file);
    }

    // JSONãƒ‘ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function getValueByPath(obj, path) {
        const parts = path.split('.');
        let current = obj;
        for (const part of parts) {
            if (current === undefined || current === null) return undefined;
            current = current[part];
        }
        return current;
    }

    // JSONãƒ‘ã‚¹ã«å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ (è¦ªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã—ãªã„ç°¡æ˜“ç‰ˆ)
    function setValueByPath(obj, path, value) {
        const parts = path.split('.');
        let current = obj;
        for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            if (!current[part]) {
                // ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã¯ä½•ã‚‚ã—ãªã„ã‹ã€æ§‹é€ ã‚’ä½œã‚‹ã‹
                // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€Œæ—¢å­˜ã®æ§‹é€ ãŒã‚ã‚‹å ´åˆã®ã¿å¤‰æ›´ã€ã¨ã™ã‚‹
                // ã‚‚ã—æ§‹é€ ã‚’ä½œã‚ŠãŸã„å ´åˆã¯ current[part] = {} ã‚’è¿½åŠ 
                return false; 
            }
            current = current[part];
        }
        const lastPart = parts[parts.length - 1];
        
        // é…åˆ—å¤‰æ› (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆ)
        if (Array.isArray(current[lastPart]) && typeof value === 'string') {
             current[lastPart] = value.split(',').map(s => s.trim());
        } else {
             current[lastPart] = value;
        }
        return true;
    }

    // å·¦ãƒ‘ãƒãƒ«ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ç”Ÿæˆ
    function renderControls() {
        paramsContainer.innerHTML = '';
        
        paramConfig.forEach(config => {
            const val = getValueByPath(currentData, config.path);
            
            // å€¤ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã¾ãŸã¯è¿½åŠ ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºãªã©ã®å®Ÿè£…ã‚‚ã‚ã‚Šï¼‰
            if (val === undefined) return;

            const div = document.createElement('div');
            div.className = 'control-group';

            const label = document.createElement('label');
            label.textContent = config.label;
            
            const desc = document.createElement('div');
            desc.className = 'desc';
            desc.textContent = config.desc;

            let input;
            if (config.type === 'array') {
                input = document.createElement('input');
                input.type = 'text';
                input.value = Array.isArray(val) ? val.join(', ') : val;
            } else if (config.type === 'number') {
                input = document.createElement('input');
                input.type = 'number';
                input.step = "0.01";
                input.value = val;
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.value = val;
            }

            input.addEventListener('input', (e) => {
                let newValue = e.target.value;
                if (config.type === 'number') newValue = parseFloat(newValue);
                
                const success = setValueByPath(currentData, config.path, newValue);
                if (success) {
                    renderCode(config.path, newValue);
                }
            });

            div.appendChild(label);
            div.appendChild(desc);
            div.appendChild(input);
            paramsContainer.appendChild(div);
        });

        if (paramsContainer.innerHTML === '') {
            paramsContainer.innerHTML = '<p style="padding:10px; color:#aaa;">ç·¨é›†å¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>æ§‹é€ ãŒæ¨™æº–çš„ãªEntity JSONã¨ç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>';
        }
    }

    // å³ãƒ‘ãƒãƒ«ã®ã‚³ãƒ¼ãƒ‰æç”»ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
    function renderCode(changedPath = null, changedValue = null) {
        // JSONã‚’æ–‡å­—åˆ—åŒ–
        const jsonString = JSON.stringify(currentData, null, 2);
        
        // å˜ç´”ãªãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¨­å®šã™ã‚‹ã®ã§ã¯ãªãã€è¡Œã”ã¨ã«åˆ†å‰²ã—ã¦spanã«å…¥ã‚Œã‚‹
        // ã“ã‚Œã«ã‚ˆã‚Šè¡Œã”ã¨ã®åˆ¶å¾¡ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ãŒå¯èƒ½ã«ãªã‚‹
        codeView.innerHTML = '';
        
        const lines = jsonString.split('\n');
        let targetElement = null;

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã¹ãè¡Œã‚’æ¢ã™ãŸã‚ã®å˜ç´”ãªãƒ­ã‚¸ãƒƒã‚¯
        // ãƒ‘ã‚¹ã®æœ€å¾Œã®ã‚­ãƒ¼ï¼ˆä¾‹: "value"ï¼‰ã¨ã€è¨­å®šã—ãŸå€¤ãŒå«ã¾ã‚Œã‚‹è¡Œã‚’æ¢ã™
        // æ³¨æ„: åŒã˜å€¤ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã€æœ€åˆã®ã‚‚ã®ã«ãƒ’ãƒƒãƒˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€
        // ç°¡æ˜“å®Ÿè£…ã¨ã—ã¦ã€å¤‰æ›´ã—ãŸç›´å¾Œã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ã¯ã€Œã‚­ãƒ¼ã€ã¨ã€Œå€¤ã€ã®ä¸¡æ–¹ãŒå«ã¾ã‚Œã‚‹è¡Œã‚’å„ªå…ˆã™ã‚‹
        let searchKey = "";
        let searchValStr = "";
        
        if (changedPath) {
            const parts = changedPath.split('.');
            searchKey = parts[parts.length - 1]; // ä¾‹: "value"
            searchValStr = String(changedValue);
        }

        lines.forEach((lineText, index) => {
            const div = document.createElement('div');
            div.className = 'line';
            div.textContent = lineText; // ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å®‰å…¨ã«æŒ¿å…¥
            
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆåˆ¤å®š
            if (changedPath) {
                // è¡Œã®ä¸­ã« "ã‚­ãƒ¼": ... å€¤ ... ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
                // å®Œå…¨ãªãƒ‘ãƒ¼ã‚µãƒ¼ã§ã¯ãªã„ãŸã‚èª¤æ¤œçŸ¥ã®å¯èƒ½æ€§ã¯ã‚ã‚‹ãŒã€ä½¿ç”¨æ„Ÿã¨ã—ã¦ã¯ååˆ†
                if (lineText.includes(`"${searchKey}"`) && lineText.includes(searchValStr)) {
                    // ä»¥å‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™ (å…¨å†æç”»ãªã®ã§è‡ªå‹•ã§æ¶ˆãˆã‚‹)
                    div.classList.add('highlight');
                    targetElement = div;
                }
            }

            codeView.appendChild(div);
        });

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
        if (targetElement) {
            // å°‘ã—é…ã‚‰ã›ã¦DOMæç”»ã‚’å¾…ã¤å¿…è¦ã¯ãªã„ãŒã€ã‚¹ãƒ ãƒ¼ã‚ºãªè¦‹ãŸç›®ã®ãŸã‚ã«
            setTimeout(() => {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);
        }
    }

    // åˆæœŸè¡¨ç¤º
    renderCode();

</script>
</body>
</html>
