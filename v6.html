<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC Entity Editor Advanced</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --highlight-color: #585816;
            --border-color: #3e3e42;
            --pocket-bg: #333333;
            --input-bg: #3c3c3c;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #app {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* --- å·¦ãƒ‘ãƒãƒ« --- */
        #sidebar {
            width: 380px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* ãƒã‚±ãƒƒãƒˆ */
        #pocket {
            width: 100%;
            height: 80px;
            border: 2px dashed #555;
            border-radius: 8px;
            background-color: var(--pocket-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
            color: #aaa;
            flex-shrink: 0;
        }

        #pocket:hover, #pocket.dragover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background-color: #2a2d2e;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .control-group {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
        }
        
        .control-group.disabled {
            opacity: 0.5;
            pointer-events: none; /* ç·¨é›†ä¸å¯ã«ã™ã‚‹ */
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .control-group .desc {
            font-size: 11px;
            color: #888;
            margin-bottom: 6px;
        }

        .status-tag {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 2px;
            background: #444;
            font-weight: normal;
        }
        .status-tag.missing { background: #5a3030; color: #ffcccc; }
        .status-tag.found { background: #305a5a; color: #ccffff; }
        .status-tag.added { background: #305a30; color: #ccffcc; }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 5px;
            background-color: var(--input-bg);
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }

        input:focus { border-color: var(--accent-color); outline: none; }

        /* åº§å¸­ã‚¨ãƒ‡ã‚£ã‚¿ */
        .seat-editor {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 5px;
            margin-top: 5px;
        }
        .seat-item { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .seat-item input { width: 33%; text-align: center; }
        .btn-mini {
            background: #444; border: none; color: white; cursor: pointer;
            border-radius: 3px; padding: 2px 6px; font-size: 12px;
        }
        .btn-mini:hover { background: #666; }
        .btn-mini.danger { background: #843232; }
        .btn-add { width: 100%; margin-top: 5px; background: #3a5a3a; }

        /* --- å³ãƒ‘ãƒãƒ« --- */
        #editor-container {
            flex: 1;
            position: relative;
            background-color: #1e1e1e;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #toolbar {
            height: 40px;
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            justify-content: space-between;
            flex-shrink: 0;
        }

        #code-view {
            flex: 1;
            padding: 20px;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            color: #d4d4d4;
            tab-size: 4;
        }

        .line { display: block; min-height: 1.5em; }
        .highlight {
            background-color: var(--highlight-color);
            animation: highlightFade 1.5s ease-out;
        }
        @keyframes highlightFade {
            0% { background-color: #888822; }
            100% { background-color: var(--highlight-color); }
        }

        footer {
            height: 30px;
            background-color: var(--panel-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #888;
            flex-shrink: 0;
            z-index: 10;
        }
        footer a { color: var(--accent-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        .btn {
            background-color: var(--accent-color); color: white; border: none;
            padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px;
        }
        .btn:hover { opacity: 0.9; }
        .btn.secondary { background-color: #444; }
        
        .status-badge {
            font-size: 12px; padding: 2px 6px; border-radius: 3px; margin-right: 10px;
            background: #333; color: #aaa;
        }
        .status-badge.active { background: #8e3e3e; color: white; }

    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div id="pocket" title="ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—">
            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—<br>
            <span style="font-size:0.8em">(ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ)</span>
            <input type="file" id="fileInput" accept=".json" style="display: none;">
        </div>
        <div id="parameters">
            <p style="text-align: center; color: #666; margin-top: 50px;">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨<br>ã“ã“ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
            </p>
        </div>
    </div>

    <div id="editor-container">
        <div id="toolbar">
            <div>
                <span id="edit-status" class="status-badge">View Only</span>
                <span id="filename-display" style="font-size: 12px; color: #888;"></span>
            </div>
            <div>
                <button class="btn secondary" id="toggle-edit-btn">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
                <button class="btn" id="download-btn">JSONã‚’ä¿å­˜</button>
            </div>
        </div>
        <div id="code-view" contenteditable="false">
            // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
        </div>
    </div>
</div>

<footer>
    Provided by&nbsp;<a href="https://example.com" target="_blank">example.com</a>
</footer>

<script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let currentData = {};
    let currentFileName = "entity.json";
    let isEditMode = false;

    // --- è¨­å®š: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å®šç¾© ---
    const paramConfig = [
        {
            id: "identifier",
            label: "ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID",
            desc: "ã‚²ãƒ¼ãƒ å†…ã§ã®è­˜åˆ¥ID",
            type: "direct_path",
            path: "minecraft:entity.description.identifier",
            inputType: "text"
        },
        {
            id: "health",
            label: "ä½“åŠ› (Health)",
            desc: "æœ€å¤§HP (1ãšã¤)",
            type: "component",
            component: "minecraft:health",
            key: "value", 
            inputType: "number",
            step: 1
        },
        {
            id: "attack",
            label: "æ”»æ’ƒåŠ› (Damage)",
            desc: "æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸ (1ãšã¤)",
            type: "component",
            component: "minecraft:attack",
            key: "damage",
            inputType: "number",
            step: 1
        },
        {
            id: "width",
            label: "å½“ãŸã‚Šåˆ¤å®š: å¹…",
            desc: "Collision Box Width",
            type: "component",
            component: "minecraft:collision_box",
            key: "width",
            inputType: "number",
            step: 0.1
        },
        {
            id: "height",
            label: "å½“ãŸã‚Šåˆ¤å®š: é«˜ã•",
            desc: "Collision Box Height",
            type: "component",
            component: "minecraft:collision_box",
            key: "height",
            inputType: "number",
            step: 0.1
        },
        {
            id: "scale",
            label: "å¤§ãã• (Scale)",
            desc: "ãƒ¢ãƒ‡ãƒ«ã®ã‚µã‚¤ã‚º (å¤§äºº)ã€‚ãªã‘ã‚Œã°è¿½åŠ ã€‚",
            type: "component_force_add",
            component: "minecraft:scale",
            key: "value",
            inputType: "number",
            step: 0.1
        },
        {
            id: "nearest_target",
            label: "æ•µå¯¾ç¯„å›² (Radius)",
            desc: "å¤‰æ›´æ™‚ max_dist = å€¤+10 ã«è‡ªå‹•æ›´æ–°",
            type: "custom_behavior_range",
            component: "minecraft:behavior.nearest_attackable_target",
            key: "within_radius",
            inputType: "number",
            step: 1
        },
        {
            id: "melee_cooldown",
            label: "æ”»æ’ƒé–“éš” (Melee)",
            desc: "ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ  (ç§’)ã€‚ãªã‘ã‚Œã°è¿½åŠ ã€‚",
            type: "custom_behavior_melee",
            component: "minecraft:behavior.melee_attack",
            key: "cooldown_time",
            inputType: "number",
            step: 0.1
        },
        {
            id: "burst_shots",
            label: "é€£å°„æ•° (Blazeç­‰)",
            desc: "Range Attack burst shots",
            type: "component",
            component: "minecraft:behavior.ranged_attack",
            key: "burst_shots",
            inputType: "number",
            step: 1
        },
        {
            id: "loot",
            label: "ãƒ‰ãƒ­ãƒƒãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«",
            desc: "Loot Table Path",
            type: "component",
            component: "minecraft:loot",
            key: "table",
            inputType: "text"
        },
        {
            id: "seats",
            label: "åº§å¸­ä½ç½® (Rideable)",
            desc: "æ­ä¹—ä½ç½® (XYZ)",
            type: "custom_seats",
            component: "minecraft:rideable",
            inputType: "seats",
            step: 0.1
        }
    ];

    // --- DOMè¦ç´  ---
    const pocket = document.getElementById('pocket');
    const fileInput = document.getElementById('fileInput');
    const paramsContainer = document.getElementById('parameters');
    const codeView = document.getElementById('code-view');
    const toggleEditBtn = document.getElementById('toggle-edit-btn');
    const editStatus = document.getElementById('edit-status');
    const downloadBtn = document.getElementById('download-btn');
    const filenameDisplay = document.getElementById('filename-display');

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    pocket.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => loadFile(e.target.files[0]));
    pocket.addEventListener('dragover', (e) => { e.preventDefault(); pocket.classList.add('dragover'); });
    pocket.addEventListener('dragleave', () => pocket.classList.remove('dragover'));
    pocket.addEventListener('drop', (e) => {
        e.preventDefault();
        pocket.classList.remove('dragover');
        if (e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
    });

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    toggleEditBtn.addEventListener('click', () => {
        isEditMode = !isEditMode;
        codeView.contentEditable = isEditMode;
        if (isEditMode) {
            editStatus.textContent = "Editing Code";
            editStatus.classList.add('active');
            codeView.style.border = "1px solid #8e3e3e";
        } else {
            editStatus.textContent = "View Only";
            editStatus.classList.remove('active');
            codeView.style.border = "none";
            try {
                // ãƒ†ã‚­ã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ã®å†…å®¹ã‚’ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
                currentData = JSON.parse(codeView.innerText);
                renderControls();
                renderCode();
            } catch (e) {
                alert("JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: " + e.message + "\nç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¾ã¾ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
                isEditMode = true;
                codeView.contentEditable = true;
                editStatus.textContent = "Editing Code";
                editStatus.classList.add('active');
            }
        }
    });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ä¿®æ­£ç®‡æ‰€
    downloadBtn.addEventListener('click', () => {
        // ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (!currentData || Object.keys(currentData).length === 0) return;

        let dataToSave = currentData;

        // ã€é‡è¦ã€‘ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã€ã‚ã‚‹ã„ã¯åŒæœŸã‚ºãƒ¬ã‚’é˜²ããŸã‚
        // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ­£ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
        try {
            const currentText = codeView.innerText;
            if (currentText && currentText.trim().length > 0) {
                dataToSave = JSON.parse(currentText);
                // å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚‚åŒæœŸã—ã¦ãŠã
                currentData = dataToSave; 
            }
        } catch (e) {
            alert("ã‚³ãƒ¼ãƒ‰ã®JSONå½¢å¼ãŒæ­£ã—ããªã„ãŸã‚ä¿å­˜ã§ãã¾ã›ã‚“ã€‚\nã‚¨ãƒ©ãƒ¼: " + e.message);
            return;
        }

        const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFileName;
        a.click();
        URL.revokeObjectURL(url);
    });

    // --- ãƒ­ã‚¸ãƒƒã‚¯ ---

    function loadFile(file) {
        if (!file) return;
        currentFileName = file.name;
        filenameDisplay.textContent = currentFileName;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                currentData = JSON.parse(e.target.result);
                renderControls();
                renderCode();
            } catch (err) {
                alert("èª­ã¿è¾¼ã¿å¤±æ•—: " + err);
            }
        };
        reader.readAsText(file);
    }

    // å†å¸°çš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’èµ°æŸ»ã—ã¦ max_dist ã‚’å…¨ã¦æ›´æ–°ã™ã‚‹
    function recursiveUpdateMaxDist(obj, newVal) {
        if (typeof obj !== 'object' || obj === null) return;
        
        for (const key in obj) {
            if (key === 'max_dist') {
                obj[key] = newVal;
            } else {
                recursiveUpdateMaxDist(obj[key], newVal);
            }
        }
    }

    // JSONå†…ã‹ã‚‰æŒ‡å®šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã¤å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™ï¼ˆGroupså«ã‚€ï¼‰
    function findAllComponents(data, componentName) {
        let results = [];
        const entity = data["minecraft:entity"];
        if (!entity) return results;

        // 1. ãƒ¡ã‚¤ãƒ³ components
        if (entity.components && entity.components[componentName]) {
            results.push(entity.components[componentName]);
        }

        // 2. Component Groups
        if (entity.component_groups) {
            for (const groupName in entity.component_groups) {
                const group = entity.component_groups[groupName];
                if (group[componentName]) {
                    results.push(group[componentName]);
                }
            }
        }
        return results;
    }

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æç”»
    function renderControls() {
        paramsContainer.innerHTML = '';
        if (Object.keys(currentData).length === 0) return;

        paramConfig.forEach(config => {
            const group = document.createElement('div');
            
            // --- å€¤ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ ---
            let value = undefined;
            let componentsFound = [];
            let isFound = false;

            if (config.type === 'direct_path') {
                value = getValueByPath(currentData, config.path);
                isFound = (value !== undefined);
            } else {
                componentsFound = findAllComponents(currentData, config.component);
                isFound = (componentsFound.length > 0);
                if (isFound) {
                    value = componentsFound[0][config.key];
                    if (value === undefined && config.type === 'custom_behavior_melee') {
                        value = "æœªè¨­å®š"; 
                    }
                }
            }

            // --- çŠ¶æ…‹åˆ¤å®š ---
            let isDisabled = !isFound;
            if (config.type === 'component_force_add') isDisabled = false;

            group.className = 'control-group' + (isDisabled ? ' disabled' : '');

            // ãƒ©ãƒ™ãƒ«
            const label = document.createElement('label');
            let statusBadge = '';
            if (!isFound) {
                if(config.type === 'component_force_add') statusBadge = '<span class="status-tag added">è¿½åŠ å¯èƒ½</span>';
                else statusBadge = '<span class="status-tag missing">ãªã—</span>';
            } else if (componentsFound.length > 1) {
                statusBadge = '<span class="status-tag found">è¤‡æ•°ç®‡æ‰€</span>';
            }
            label.innerHTML = `${config.label} ${statusBadge}`;
            
            const desc = document.createElement('div');
            desc.className = 'desc';
            desc.textContent = config.desc;

            group.appendChild(label);
            group.appendChild(desc);

            // --- å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆ ---
            
            // ç‰¹æ®Š: åº§å¸­ã‚¨ãƒ‡ã‚£ã‚¿
            if (config.type === 'custom_seats') {
                if (isDisabled) {
                    const input = document.createElement('input'); input.disabled = true; input.value = "ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãªã—";
                    group.appendChild(input);
                } else {
                    const editorDiv = document.createElement('div');
                    editorDiv.className = 'seat-editor';
                    
                    const mainComp = componentsFound[0];
                    let seatsData = mainComp.seats ? (Array.isArray(mainComp.seats) ? mainComp.seats : [mainComp.seats]) : [];

                    const renderSeats = () => {
                        editorDiv.innerHTML = '<div style="display:flex; font-size:10px; color:#aaa; margin-bottom:2px;"><span style="width:33%;text-align:center">X</span><span style="width:33%;text-align:center">Y</span><span style="width:33%;text-align:center">Z</span><span style="width:20px;"></span></div>';
                        seatsData.forEach((seat, idx) => {
                            const row = document.createElement('div');
                            row.className = 'seat-item';
                            const pos = seat.position || [0,0,0];
                            [0,1,2].forEach(axis => {
                                const input = document.createElement('input');
                                input.type = 'number'; input.step = 0.1; input.value = pos[axis];
                                input.addEventListener('input', (e) => {
                                    pos[axis] = parseFloat(e.target.value);
                                    seat.position = pos;
                                    componentsFound.forEach(c => {
                                        c.seats = JSON.parse(JSON.stringify(seatsData));
                                    });
                                    renderCode("minecraft:rideable", "seats");
                                });
                                row.appendChild(input);
                            });
                            const delBtn = document.createElement('button');
                            delBtn.textContent = 'Ã—'; delBtn.className = 'btn-mini danger';
                            delBtn.onclick = () => {
                                seatsData.splice(idx, 1);
                                componentsFound.forEach(c => c.seats = JSON.parse(JSON.stringify(seatsData)));
                                renderSeats();
                                renderCode("minecraft:rideable", "seats");
                            };
                            row.appendChild(delBtn);
                            editorDiv.appendChild(row);
                        });
                        const addBtn = document.createElement('button');
                        addBtn.textContent = '+ åº§å¸­ã‚’è¿½åŠ '; addBtn.className = 'btn-mini btn-add';
                        addBtn.onclick = () => {
                            seatsData.push({ position: [0,0,0] });
                            componentsFound.forEach(c => c.seats = JSON.parse(JSON.stringify(seatsData)));
                            renderSeats();
                            renderCode("minecraft:rideable", "seats");
                        };
                        editorDiv.appendChild(addBtn);
                    };
                    renderSeats();
                    group.appendChild(editorDiv);
                }
            } 
            // é€šå¸¸: ãƒ†ã‚­ã‚¹ãƒˆ/æ•°å€¤
            else {
                const input = document.createElement('input');
                input.type = config.inputType;
                if (config.step) input.step = config.step;
                input.disabled = isDisabled;

                if (!isDisabled) {
                    input.value = (value !== undefined) ? value : "";
                    if (config.type === 'custom_behavior_melee' && value === "æœªè¨­å®š") {
                        input.placeholder = "å€¤ã‚’å…¥åŠ›ã—ã¦è¿½åŠ ";
                        input.value = "";
                    }
                } else if (config.type === 'component_force_add') {
                    input.placeholder = "å€¤ã‚’å…¥åŠ›ã—ã¦è¿½åŠ ";
                } else {
                    input.value = "N/A";
                }

                // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ 'change' ã‹ã‚‰ 'input' ã«å¤‰æ›´ã—ã€å³æ™‚åæ˜ ã•ã›ã‚‹
                input.addEventListener('input', (e) => {
                    let val = e.target.value;
                    if (config.inputType === 'number') {
                        // ç©ºæ–‡å­—ã‚„æ•°å€¤å¤‰æ›ã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—(ã‚¨ãƒ©ãƒ¼é˜²æ­¢)
                        if(val === '') return;
                        val = parseFloat(val);
                    }

                    // --- æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯åˆ†å² ---
                    if (config.type === 'direct_path') {
                        setValueByPath(currentData, config.path, val);
                        renderCode(config.id, val);
                    } 
                    else if (config.type === 'component_force_add') {
                        let entity = currentData["minecraft:entity"];
                        if(!entity.components) entity.components = {};
                        entity.components[config.component] = { [config.key]: val };
                        // æ–°è¦è¿½åŠ æ™‚ã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è‡ªä½“ã‚’å†æç”»ã—ãªã„ã¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŒ
                        // ã“ã“ã§ã¯å€¤ãŒå¤‰ã‚ã‚‹ã ã‘ãªã®ã§å†æç”»ã›ãšã€æ¬¡å›ã®æ“ä½œã§åæ˜ 
                        renderCode(config.key, val);
                    }
                    else if (config.type === 'custom_behavior_range') {
                        componentsFound.forEach(comp => {
                            comp[config.key] = val; // within_radius
                            recursiveUpdateMaxDist(comp, val + 10);
                        });
                        renderCode(config.key, val);
                    }
                    else if (config.type === 'custom_behavior_melee') {
                        componentsFound.forEach(comp => {
                            comp[config.key] = val;
                        });
                        renderCode(config.key, val);
                    }
                    else {
                        componentsFound.forEach(comp => {
                            comp[config.key] = val;
                        });
                        renderCode(config.key, val);
                    }
                });
                
                // æ–°è¦è¿½åŠ æ™‚ã®ãŸã‚ã®changeã‚¤ãƒ™ãƒ³ãƒˆï¼ˆforce_addç”¨ï¼‰
                if (config.type === 'component_force_add') {
                     input.addEventListener('change', () => renderControls());
                }

                group.appendChild(input);
            }

            paramsContainer.appendChild(group);
        });
    }

    // ãƒ‘ã‚¹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function getValueByPath(obj, path) {
        if (!obj) return undefined;
        const parts = path.split('.');
        let current = obj;
        for (const p of parts) {
            if (current === undefined || current === null) return undefined;
            current = current[p];
        }
        return current;
    }
    
    function setValueByPath(obj, path, val) {
        const parts = path.split('.');
        let current = obj;
        for (let i=0; i<parts.length-1; i++) {
            if(!current[parts[i]]) return; // ãƒ‘ã‚¹é€”åˆ‡ã‚Œé˜²æ­¢
            current = current[parts[i]];
        }
        current[parts[parts.length-1]] = val;
    }

    // ã‚³ãƒ¼ãƒ‰æç”» & ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    function renderCode(highlightKey = null, highlightVal = null) {
        // ç¾åœ¨ã®currentDataã‚’æ–‡å­—åˆ—åŒ–ã—ã¦è¡¨ç¤º
        const jsonStr = JSON.stringify(currentData, null, 2);
        codeView.innerText = jsonStr; // å®‰å…¨ã®ãŸã‚textContent/innerTextã‚’ä½¿ç”¨

        // HTMLãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ã®ãŸã‚ã«å†åº¦ä¸­èº«ã‚’æ§‹ç¯‰
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã€innerTextã§è¨­å®šã—ãŸå¾Œã«HTMLåŠ å·¥ã‚’è¡Œã†
        const lines = jsonStr.split('\n');
        codeView.innerHTML = ''; // ã‚¯ãƒªã‚¢

        let targetElement = null;
        let searchKeyStr = highlightKey ? `"${highlightKey}"` : null;
        if (searchKeyStr && searchKeyStr.includes('.')) {
            const parts = highlightKey.split('.');
            searchKeyStr = `"${parts[parts.length-1]}"`;
        }

        lines.forEach(line => {
            const div = document.createElement('div');
            div.className = 'line';
            div.textContent = line;
            
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆåˆ¤å®š
            if (searchKeyStr && line.includes(searchKeyStr)) {
                if (highlightVal !== null && line.includes(String(highlightVal))) {
                    div.classList.add('highlight');
                    targetElement = div;
                } 
                else if (highlightVal === "seats" || highlightVal === null) {
                    div.classList.add('highlight');
                    targetElement = div;
                }
            }
            codeView.appendChild(div);
        });

        if (targetElement) {
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®ãƒãƒ©ã¤ãé˜²æ­¢ã®ãŸã‚å¾®å°é…å»¶
            setTimeout(() => targetElement.scrollIntoView({block:'center', behavior:'smooth'}), 10);
        }
    }

</script>
</body>
</html>
